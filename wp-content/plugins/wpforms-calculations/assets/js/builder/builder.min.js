let WPFormsCalculationsBuilder=window.WPFormsCalculationsBuilder||((e,r,f)=>{let n={$document:f(e),$builder:f("#wpforms-builder")},s={codemirror:{}},p,u={autocompleteTriggeredBy:"keyup",init(){navigator.userAgent.toLowerCase().includes("mac")&&e.body.classList.add("is-mac"),s.codemirror.options={theme:"mdn-like",mode:"text/x-php",startOpen:!1,scrollbarStyle:"native",lineNumbers:!0,readOnly:!1,autoCloseBrackets:!0,matchBrackets:!0,indentUnit:4,indentWithTabs:!0,enterMode:"keep",tabMode:"shift",hintOptions:{hint:u.getAutocompleteData,completeSingle:!1}},s.codemirror.expandedEditorWidth=720,s.codemirror.editors={},n.$builder.on("wpformsBuilderReady",u.ready)},ready(){p.init(),u.initFieldsOptions(),u.events()},events(){n.$builder.on("wpformsFieldAdd",p.add).on("wpformsFieldDelete",p.delete).on("wpformsFieldMove",p.move).on("wpformsFieldDuplicated",p.duplicated).on("click",".wpforms-field-option-row-choices .add",p.updateChoicesField).on("click",".wpforms-field-option-row-choices .remove",p.updateChoicesField),n.$builder.on("click",".wpforms-field-option-group .wpforms-field-option-group-toggle",u.clickOptionGroup).on("change",".wpforms-field-option-row-calculation_is_enabled input",u.toggleCodeEditor).on("click",".wpforms-calculations-expand-editor",u.expandCollapseEditor).on("click",".wpforms-calculations-validate-formula",u.validateFormula).on("focus",".wpforms-calculations-editor-wrap .toolbar button",u.toolbarButtonFocus).on("click",".wpforms-calculations-editor-wrap .toolbar button",u.toolbarButtonClick).on("keyup",".wpforms-calculations-editor-wrap .toolbar button",u.toolbarButtonEnterKey).on("change",".wpforms-field-option :input",u.fieldOptionChange).on("mouseover",".cm-variable-2",u.variableHover).on("wpformsBeforeFieldDeleteAlert",u.fieldDeleteConfirmAlert).on("wpformsCalcFieldChange wpformsFieldAdd wpformsFieldDelete wpformsFieldDuplicated",u.updateFieldsEvent).on("wpformsFieldDuplicated",u.fieldDuplicated).on("wpformsFieldOptionTabToggle",u.fieldTabToggle).on("click",".wpforms-ai-calculations-button:not(.education-modal)",u.clickGenerateFormulaButton),n.$document.on("wpformsFieldUpdate",u.updateFieldsEvent)},initFieldsOptions(){var e,t=wpf.getFields(p.calculationIsPossibleTypes,!0);for(e in t){var o=t[e],i=f("#wpforms-field-option-"+o.id),o=o.calculation_is_enabled;u.toggleFieldDisabledOptions(i,o)}},clickOptionGroup(){var e=f(this).closest(".wpforms-field-option-group");e.hasClass("wpforms-field-option-group-advanced")&&u.setupAllEditors(e)},fieldTabToggle(e,t){var o;!t&&0!==Number(t)||["add-fields","field-options"].includes(t)||(o=f("#wpforms-field-option-"+t),t=(t=wpf.getField(t))&&t.calculation_is_enabled&&t.calculation_code?.length,o.length&&t&&(u.setupAllEditors(o),u.collapseEditor(o.find(".wpforms-calculations-expand-editor")),u.toggleFieldDisabledOptions(o,t)))},clickGenerateFormulaButton(){var e=u.prepareModalArgs(this);e&&WPFormsAIModal.initModal(e)},clickFixWithAiButton(e,t){e=u.prepareModalArgs(this,e,t);e&&WPFormsAIModal.initModal(e)},prepareModalArgs(e,t=[],o=null){if(o=o??f(e).data("field-id"),f(`.jconfirm-wpforms-ai-modal:not(.jconfirm-wpforms-ai-modal-calculations-${o})`).addClass("wpforms-hidden").fadeOut(),u.maybeReopenModal(o,t))return null;function i(){return f(".jconfirm-wpforms-ai-modal-calculations-"+o).addClass("wpforms-hidden").fadeOut(),!1}let l={};return 0<t.length?(e=u.getInitialPrompt(t),l.content=`<wpforms-ai-chat mode="calculations" field-id="${o}" prefill="${e}" auto-submit="true" />`):l.content=`<wpforms-ai-chat mode="calculations" field-id="${o}" />`,l.theme="wpforms-ai-modal, wpforms-ai-purple, wpforms-ai-modal-calculations-"+o,l.backgroundDismiss=i,l.backgroundDismissAnimation="",l.contentMaxHeight=Math.min(WPFormsAIModal.defaultOptions.contentMaxHeight,WPFormsAIModal.getMaxModalHeight()),l.onOpen=function(){setTimeout(()=>{var e=f(".jconfirm-wpforms-ai-modal-calculations-"+o).find(".jconfirm-closeIcon");e.off("click"),e.on("click",i),WPFormsAIModal.resizeModalHeight(o)},0)},l.onOpenBefore=function(){wpFormsAIDock.init(o)},l},getInitialPrompt(e){e=e.map(e=>"Error message: "+wpf.sanitizeHTML(e)).join("<br>");return`<div>${wpforms_calculations.strings.fixWithAiInitialPrompt}<p>${e}</p></div>`},maybeReopenModal(e,i){let l=f(".jconfirm-wpforms-ai-modal-calculations-"+e);return!!l.length&&(setTimeout(()=>{var e,t,o;l.filter(":last").removeClass("wpforms-hidden").fadeIn(),i.length&&(e=l.find(".wpforms-ai-chat-message-input textarea"),t=l.find(".wpforms-ai-chat-message-input button.wpforms-ai-chat-send"),o=u.getInitialPrompt(i),e.val(o),t.click())},100),!0)},fieldDeleteConfirmAlert(e,t){var o=p.getUsedInFields(t.id);if(o){var i,l=Object.keys(o),a=[];let e;for(i of l)a.push(`${o[i]} (${wpforms_calculations.strings.field} #${i})`);e=1<l.length?wpforms_calculations.strings.thisFieldUsedInFields+"<br><br>"+wpforms_calculations.strings.fields+" #"+a.join("<br>"):wpforms_calculations.strings.thisFieldUsedInField+"<br><br>"+a[0],t.trigger=!0,t.message=t.message+"<br><br>"+e+"<br>"}},fieldOptionChange(e){var t=f(this).closest(".wpforms-field-option"),o=t.find(".wpforms-field-option-hidden-type").val();Object.keys(wpforms_calculations.allowedFields).filter(function(e){return 0<wpforms_calculations.allowedFields[e].length&&!e.includes("payment")}).includes(o)&&(p.add(e,t.data("field-id"),o),u.updateInsertFieldDropdowns())},variableHover(){var o=f(this),i=o.text().match(/^\$F\d*(_[A-Za-z0-9]+)*/gm);if(i&&i[0]){var i=i[0].split("_"),l=i[0].replace("$F","");if(l){let t;try{t=wpf.getField(l)}catch(e){return}if(t){l=i[1]||null;let e=t.label;l&&(e+=` (${l})`),o.attr("title",e)}}}},toggleCodeEditor(){var o=f(this);if(!o.prop("disabled")){var e=o.prop("checked"),o=o.closest(".wpforms-field-option-group-inner"),t=o.closest(".wpforms-field-option"),o=o.find(".wpforms-field-option-row-calculation_code");if(u.toggleFieldDisabledOptions(t,e),e){let e=o.closest(".wpforms-field-options.wpforms-tab-content")[0],t=o.closest(".wpforms-field-option-group-inner");t.css("padding-bottom","250px"),e.scrollBy({top:250}),o.slideDown(200,function(){t.css("padding-bottom","")}),u.setupSingleEditor(o.find("textarea.wpforms-codemirror-editor"))}else o.slideUp()}},toggleFieldDisabledOptions(e,t){var o=e.find(".wpforms-field-option-row-min_max input"),i=e.data("field-id"),l=e.find(".wpforms-field-option-hidden-type").val(),a=n.$builder.find(`#wpforms-field-${i} .primary-input`),i=n.$builder.find(`#wpforms-field-${i} .price`),r=e.find(".wpforms-field-option-row-price input");let s=e.find(".wpforms-field-option-row-default_value input");(s="payment-single"===l?e.find(".wpforms-field-option-row-price input"):s).prop("readonly",t),o.prop("readonly",t),r.prop("readonly",t),a.val(t?"":s.val()),i.html(wpf.amountFormatCurrency(t?"":r.val()))},setupAllEditors(e){e=e||n.$builder,f("textarea.wpforms-codemirror-editor",e).each(function(){u.setupSingleEditor(f(this))})},setupSingleEditor(e,t=!1){var o,i;wp.codeEditor&&(e=e||f(this)).is(":visible")&&(o=e.attr("id"),s.codemirror.editors[o]&&!t||(t=f.extend(!0,{},s.codemirror.options),e=wp.codeEditor.initialize(e,{codemirror:t}),i=(t=f(e.codemirror.display.wrapper).closest(".wpforms-calculations-editor-wrap")).find(".wpforms-calculations-validate-formula"),u.getDropdownListInstance(t.find(".button-insert-field"),e.codemirror),i.toggleClass("disabled",""===e.codemirror.getValue().trim()),s.codemirror.editors[o]=e,u.singleEditorEvents(e.codemirror,t)))},singleEditorEvents(e,o){e.on("keydown",function(n,e){if(13===e.keyCode){let o=n.getDoc(),e=o.getCursor(),t=o.getLine(e.line),i=t.replaceAll(/\s/g,""),l=/if\(.*\):|elseif\(.*\):|else:/.test(i),a=t.match(/^\t+/),r=a?a[0]:"",s=l?r+"\t":r;s.length&&setTimeout(function(){var e=o.getCursor().line,t=o.getLine(e);t&&"\t"===t[t.length-1]||o.replaceRange(s,{line:e})},0)}}),e.on("keyup",function(e,t){[9,16,17,18,32,27,45,46,36,35,33,34,37,38,39,40].includes(t.keyCode)||(u.autocompleteTriggeredBy="keyup",e.execCommand("autocomplete"))}),e.on("change",function(e,t){s.autocompleteLastCompletion&&u.autocompleteInsertAfter(e,t),e.save();t=o.find(".wpforms-calculations-validate-formula");t.removeClass("error success").attr("title",""),t.toggleClass("disabled",""===e.getValue().trim())}),e.on("focus",function(){o.addClass("focused")}),e.on("blur",function(){o.removeClass("focused")}),e.on("mousedown",function(e,t){t.target.classList.contains("cm-variable-2")&&setTimeout(()=>{u.autocompleteTriggeredBy="mousedown",e.execCommand("autocomplete")},0)})},getAutocompleteData(c){let e=f(c.display.wrapper).closest(".wpforms-field-option-row").data("field-id"),p=u.getAutocompleteWords(e);return new Promise(function(d){setTimeout(function(){var e=c.getCursor(),t=c.getLine(e.line);let o=e.ch,i=e.ch;for(;o&&/[\w$]/.test(t.charAt(o-1));)--o;for(;i<t.length&&/[\w$]/.test(t.charAt(i));)++i;let l=t.slice(o,i).toLowerCase();var a=l;if(0===l.length)return d(null);"mousedown"===u.autocompleteTriggeredBy&&l.startsWith("$f")&&(l="$f");var r=[],s={};let n=0;for(let e=0;e<p.length;e++)s.text=u.isObject(p[e])?p[e].text:p[e],s.text.toLowerCase().startsWith(l)&&(s.text.toLowerCase()===a&&(n=r.length),s.text+=" ",s.text!==p[e])&&(s.displayText=p[e].displayText,s.render=function(e,t,o){f(e).append(o.displayText||o.text)},r.push(f.extend({},s)));return 0===r.length?d(null):(e={list:r,from:wp.CodeMirror.Pos(e.line,o),to:wp.CodeMirror.Pos(e.line,i),selectedHint:n},wp.CodeMirror.on(e,"pick",u.autocompletePick),wp.CodeMirror.on(e,"shown",function(){var e,t,o=f(".CodeMirror-hints"),i=o.find("li.CodeMirror-hint-active");i.length&&(e=o.offset().top,t=f(c.getWrapperElement()).offset().top,o.scrollTop(i.position().top),t<e?o.css({"margin-top":"5px","margin-bottom":"0"}):o.css({"margin-top":"0","margin-bottom":"9px"}))}),d(e))},100)})},getAutocompleteWords(e){var t=wpforms_calculations.functionsList.map(e=>e+"( )");return[].concat([{displayText:"if ( ):",text:"if (  ):\n\t\nelse:\n\t\nendif;"},"else:","elseif ( ):","endif;"],t,p.getVarsList("autocomplete",e))},autocompletePick(e){s.autocompleteLastCompletion=e},autocompleteInsertAfter(e,t){var o=s.autocompleteLastCompletion;if(delete s.autocompleteLastCompletion,"if ( ):"===o.displayText){var i=e.getDoc(),e=e.getLine(t.from.line).match(/^\s+/),l=e?e[0]:"",a=o.text?o.text.split("\n"):[];if(i.setCursor({line:t.from.line,ch:t.from.ch+5}),""!==l)for(let e=1;e<a.length;e++){var r=t.from.line+e;i.replaceRange(l+a[e],{line:r,ch:0},{line:r})}}},expandCollapseEditor(){var e=f(this);e.closest(".wpforms-field-option-row").hasClass("expanded")?u.collapseEditor(e):u.expandEditor(e)},collapseEditor(e){var t,o,i,l=e.closest(".wpforms-field-option-row");l.hasClass("expanded")&&(t=l.find(".wpforms-calculations-editor-wrap"),o=l.find(".wpforms-calculations-editor-collapsed"),i=(i=t.find(".CodeMirror"))[0]?i[0].CodeMirror:null,l.removeClass("expanded"),i.setSize("100%",""),t.appendTo(o),e.find("i").removeClass("fa-compress").addClass("fa-expand"),t.closest(".wpforms-field-options.wpforms-tab-content").css("overflow-y","auto"),n.$builder.off("click.ExpandedEditor"),i)&&(i.refresh(),i.focus())},expandEditor(a){let r=a.closest(".wpforms-field-option-row");if(!r.hasClass("expanded")){let t=r.find(".wpforms-calculations-editor-wrap"),e=r.find(".wpforms-calculations-editor-expanded"),o=t.find(".CodeMirror"),i=o[0]?o[0].CodeMirror:null,l=t.offset();i.setSize(s.codemirror.expandedEditorWidth,""),t.appendTo(e),r.addClass("expanded"),e.css("top",l.top),a.find("i").removeClass("fa-expand").addClass("fa-compress"),t.closest(".wpforms-field-options.wpforms-tab-content").css("overflow-y","hidden"),n.$builder.on("click.ExpandedEditor",function(e){e=f(e.target);e.closest(t).length||e.closest(".insert-field-dropdown").length||(n.$builder.off("click.ExpandedEditor"),r.hasClass("expanded")&&u.collapseEditor(a))}),i&&(i.refresh(),i.focus())}},validateFormula(){let i=f(this);if(!i.hasClass("disabled")){let o=i.closest(".wpforms-field-option-row").data("field-id"),e={action:"wpforms_calculations_validate_formula",_wp_http_referer:u.updateURLQueryParam(r.location.href,"_wp_http_referer"),form_id:f("#wpforms-builder-form").data("id"),field_id:o,code:wpf.getField(o).calculation_code,nonce:wpforms_builder.nonce},t=i.find(".wpforms-loading-spinner");t.length||(i.append('<i class="wpforms-loading-spinner wpforms-loading-inline"></i>'),t=i.find(".wpforms-loading-spinner")),t.show(),i.removeClass("success").removeClass("error");var l,a=u.getValidateFieldVarsError(e.code,o);a?(l=!wpforms_calculations.isAiDisabled&&["validation_variable_not_allowed","validation_field_not_allowed","validation_field_total_in_single_item","validation_subfield_not_allowed","validation_repeater_field_not_allowed"].includes(a.code),t.hide(),u.displayValidationResultModal([a.text],l,o),u.setValidateFormulaStatus(i,"error")):f.post(wpforms_builder.ajax_url,e).done(function(e){e.success?u.setValidateFormulaStatus(i,"success"):(u.setValidateFormulaStatus(i,"error"),u.displayValidationResultModal(e.data,!wpforms_calculations.isAiDisabled,o))}).fail(function(e,t){wpf.debug("Calculations:",wpforms_calculations.strings.ajaxFail,e.responseText||t),u.displayValidationResultModal(wpforms_calculations.strings.ajaxFail+" "+(e.responseText||t),!1,o),u.setValidateFormulaStatus(i,"error")}).always(function(){t.hide()})}},updateURLQueryParam(e,t,o=""){e=new URL(e);return o?e.searchParams.set(t,o):e.searchParams.delete(t),e.toString()},setValidateFormulaStatus(e,t){e.addClass(t="success"===t?"success":"error").find("+ span").attr("title","success"===t?wpforms_calculations.strings.validateButtonSuccess:wpforms_calculations.strings.validateButtonErrors)},getValidateFieldVarsError(e,t){var o,e=e.toString().matchAll(/(\$+[A-Za-z]+)(\d*)(_[A-Za-z0-9_]+)*/gm),i=u.getFormFieldsByIds();for(o of e){var l=o[1],a=o[2];if(!l||"$F"!==l||"$F"===l&&!a)return{text:wpforms_calculations.strings.validationVariableNotAllowed.replaceAll("%1$s",o[0]),code:"validation_variable_not_allowed"};if(u.isFieldInRepeater(a))return{text:wpforms_calculations.strings.validationRepeaterFieldNotAllowed.replaceAll("%1$s",a.toString()),code:"validation_repeater_field_not_allowed"};if(!i[a])return{text:wpforms_calculations.strings.validationFieldDoesntExist.replaceAll("%1$s",a.toString()),code:"validation_field_doesnt_exist"};if(!p.isAllowedField(i[a].type))return{text:wpforms_calculations.strings.validationFieldNotAllowed.replaceAll("%1$s",a.toString()).replaceAll("%2$s",i[a].type),code:"validation_field_not_allowed"};if("payment-total"===i[a].type&&"payment-single"===i[t].type)return{text:wpforms_calculations.strings.validationFieldTotalInSingleItem.replaceAll("%1$s",a.toString()).replaceAll("%2$s",t.toString()),code:"validation_field_total_in_single_item"};l=u.getValidateSubfieldVarsError(i[a],o,a);if(l)return l}return null},getValidateSubfieldVarsError(e,t,o){t=t[3]?t[3].replace("_",""):null;return!t||0===t.length||p.isAllowedSubField(t,Number(o),e)?null:{text:wpforms_calculations.strings.validationSubfieldNotAllowed.replaceAll("%1$s",o.toString()).replaceAll("%2$s",t),code:"validation_subfield_not_allowed"}},displayValidationResultModal(e,t=!1,o=0){var i;e&&0!==e.length&&(e=Array.isArray(e)?e:[e],i={title:wpforms_calculations.strings.validationModalErrorTitle,content:`${wpforms_calculations.strings.validationModalErrorMsg}
					<div class="wpforms-calculations-modal-errors">
						<ol><li>${e.join("<li>")}</ol>
					</div>`,icon:"fa fa-exclamation-circle",type:"red",boxWidth:"400px",buttons:{confirm:{text:wpforms_calculations.strings.ok,btnClass:"btn-confirm",keys:["enter"]}}},t&&(i.buttons.fix={text:wpforms_calculations.strings.fixWithAi,btnClass:"btn-fix-with-ai",keys:["enter"]},wpforms_calculations.isLicenseActive?i.buttons.fix.action=function(){u.clickFixWithAiButton(e,o)}:i.onOpen=function(){f(".btn-fix-with-ai").attr({"data-action":"license","data-field-name":wpforms_calculations.strings.aiCalculations,"data-utm-content":"AI Calculations","data-field-id":o}).addClass(" education-modal")}),f.alert(i))},toolbarButtonClick(){var e,t,o,i=f(this);i.hasClass("button-expand-editor")||(i.hasClass("button-insert-field")?u.toolbarButtonInsertFieldClick(i):(e=i.text(),o=(t=(i=u.getButtonCodeMirrorInstance(i)).getDoc()).getSelection(),i.focus(),o.length&&["(",")"].includes(e)?t.replaceSelection(" ( "+o+" ) "):o.length?t.replaceSelection(o+` ${e} `):t.replaceRange(" "+e+" ",t.getCursor())))},toolbarButtonFocus(){f(this).closest(".wpforms-calculations-editor-wrap").addClass("focused")},toolbarButtonEnterKey(e){13===e.keyCode&&f(this).click()},toolbarButtonInsertFieldClick(e){var t,o=u.getButtonCodeMirrorInstance(e),i=u.getDropdownListInstance(e,o);i&&(t=e.hasClass("active"),e.toggleClass("active",!t),t?(o.focus(),i.close()):i.open())},getDropdownListInstance(s,n){var t=s.data("dropdown-list");if(!t){var o=s.closest(".wpforms-field-option-row").data("field-id"),o=p.getVarsList("dropdown",o);if(!o.length)return s.addClass("disabled"),null;if(s.removeClass("disabled"),!(n=n||u.getButtonCodeMirrorInstance(s)))return null;let e=(t=WPForms.Admin.Builder.DropdownList.init({class:"insert-field-dropdown",title:wpforms_calculations.strings.insertFieldDropdownTitle,list:o,container:s.closest(".wpforms-field-option-row"),scrollableContainer:s.closest(".wpforms-field-options.wpforms-tab-content"),button:s,buttonDistance:21,itemFormat(e){return`<span title="${e.text}">${e.text}</span><span class="grey field-variable">${e.value}</span>`},onSelect(e,t,o,i,l){var a=n.getDoc(),r=a.getCursor();a.replaceRange(" "+t+" ",r),l.close(),s.removeClass("active")}})).open.bind(t);t.open=function(){this.$button.data("re-init")?(this.$button.data("re-init",!1),this.destroy(),p.updateVarsObject(),u.getDropdownListInstance(this.$button,null).open()):e()},s.data("dropdown-list",t)}return t},getButtonCodeMirrorInstance(e){try{return e.closest(".wpforms-calculations-editor-wrap").find(".CodeMirror")[0].CodeMirror}catch(e){return null}},updateFieldsEvent(){u.updateInsertFieldDropdowns()},updateInsertFieldDropdowns(){n.$builder.find(".wpforms-calculations-editor-wrap .button-insert-field").each(function(){var e=f(this),t=e.data("dropdown-list");t&&(e.data("re-init",!0),t.close(),e.removeClass("active"))})},fieldDuplicated(e,t,o,i,l){l.hasClass("wpforms-field-layout")?u.initDuplicatedLayoutFieldCodeEditors(l):u.initDuplicatedFieldCodeEditor(i)},initDuplicatedFieldCodeEditor(e){var t,o,i;n.$builder.find(`#wpforms-field-option-${e}-calculation_is_enabled`).length&&(o=(e=(t=n.$builder.find("#wpforms-field-option-"+e)).find(`#wpforms-field-option-row-${e}-calculation_code .wpforms-calculations-editor-wrap`)).closest(".wpforms-field-option-row-calculation_code").find(".wpforms-builder-dropdown-list"),i=e.find("textarea.wpforms-codemirror-editor"),e.find(".CodeMirror").remove(),o.remove(),i.show(),u.setupAllEditors(t))},initDuplicatedLayoutFieldCodeEditors(e){e.find(".wpforms-layout-column .wpforms-field").each(function(){var e=f(this).data("field-id");u.initDuplicatedFieldCodeEditor(e)})},isObject(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e},getFormFieldsByIds(){var e,t=wpf.getFields(),o={};for(e in t)o[t[e].id]=t[e];return o},getEditorInstance(e){return s.codemirror.editors[e]||null},isFieldInRepeater(t){var e=(wpf.formObject("#wpforms-field-options")||{}).fields??{};return Object.values(e).some(e=>"repeater"===e.type&&Object.values(e["columns-json"]??{}).some(e=>(e?.fields??[]).some(e=>e?.toString()===String(t))))}};return p={variables:null,variablesOrder:null,allowedTypes:null,calculationIsPossibleTypes:null,init(){p.allowedTypes=Object.keys(wpforms_calculations.allowedFields),p.calculationIsPossibleTypes=Object.values(wpforms_calculations.calculationIsPossibleFields),p.updateVarsObject()},isAllowedField(e){return p.allowedTypes.includes(e)},isCalculationPossible(e){return p.calculationIsPossibleTypes.includes(e)},isAllowedSubField(e,t,o=null){var i=wpf.getField(t);let l=wpforms_calculations.allowedFields[i.type];switch(i.type){case"checkbox":case"payment-checkbox":return(l=i.dynamic_choices?l:l.concat(Object.keys(i.choices))).includes(e);case"payment-multiple":case"payment-select":case"payment-single":case"payment-total":return l.includes(e);case"email":return 1===o?.confirmation&&l.includes(e);case"address":return"international"!==o.scheme&&o?.additional?.includes("country")&&(o.additional=o.additional.filter(e=>"country"!==e)),o?.additional&&o?.additional.includes(e);case"date-time":case"name":return o?.additional&&o?.additional.includes(e);default:return!1}},getUsedInFields(e){var t,o=wpf.getFields();let i=!1;for(t in o)new RegExp("\\$F"+e+"[^\\d]","mg").test(o[t].calculation_code)&&((i=i||{})[o[t].id]=wpf.sanitizeHTML(o[t].label,void 0));return i},getVarsObject(){return null===p.variables&&p.updateVarsObject(),p.variables},updateVarsObject(){p.variables={};var e,t=wpf.getFields(p.allowedTypes,!1);for(e in t)p.add({},t[e].id,t[e].type);p.updateVarsOrder()},getVars(){var e,t=p.getVarsObject();let o=[];for(e in t)o=[].concat(o,t[e]);return o},getVarsOrder(){return null===p.variablesOrder&&p.updateVarsOrder(),p.variablesOrder},updateVarsOrder(){return p.variablesOrder=[],n.$builder.find(".wpforms-preview .wpforms-field").each(function(){var e=f(this);p.isAllowedField(e.data("field-type"))&&p.variablesOrder.push(e.data("field-id"))}),p.variablesOrder},getVarsList(e,t){var o,i,l=p.getVarsObject(),a=p.getVarsOrder(),r=wpf.getField(t),s=[];for(i in e=e||"autocomplete",a){var n=a[i];if(!t||n.toString()!==t.toString()){var d=wpf.getField(n);if("payment-total"!==d.type||"payment-single"!==r.type)for(var c in l[n])o=(o=(c=l[n][c]).replace(/^\$F\d+_/,""))===c?"":o,o=(o=parseInt(o,10).toString()===o?"choice "+o:o).length?" ("+o+")":"",s.push("autocomplete"===e?{text:c,displayText:`<span>${c}</span><span title="${d.label+o}">${d.label+o}</span>`}:"dropdown"===e?{value:c,text:d.label+o}:c)}}return s},add(e,t,o){if(p.isAllowedField(o)){p.delete(e,t,o),p.variables[t]=["$F"+t];var i,l=wpf.getField(t),a=wpforms_calculations.allowedFields[o];for(i in e.type&&p.updateVarsOrder(),a)"email"===o&&!l.confirmation||"address"===o&&"us"===l.scheme&&"country"===a[i]||"address"===o&&l.postal_hide&&"postal"===a[i]||"address"===o&&l.address2_hide&&"address2"===a[i]||"name"===o&&"simple"===l.format||"name"===o&&"first-last"===l.format&&"middle"===a[i]||"date-time"===o&&"date-time"!==l.format||p.variables[t].push("$F"+t+"_"+a[i]);["checkbox","payment-checkbox"].includes(o)&&p.addChoices(t)}},duplicated(e,t,o,i,l){p.add(e,i,wpf.getField(t).type)},delete(e,t,o){p.variables[t]&&delete p.variables[t];t=p.variablesOrder?p.variablesOrder.indexOf(t):-1;-1!==t&&p.variablesOrder.splice(t,1)},move(e){p.updateVarsOrder()},addChoices(e){var t=wpf.getField(e);if(t&&t.choices&&!t.dynamic_choices)for(var o in t.choices)p.variables[e].push("$F"+e+"_"+o)},updateChoicesField(){let e=f(this),t=e.closest(".wpforms-field-option"),o=t.find(".wpforms-field-option-hidden-id").val();setTimeout(function(){n.$builder.trigger("wpformsCalcFieldChange",[o])},100)}},u})(document,window,jQuery);WPFormsCalculationsBuilder.init();