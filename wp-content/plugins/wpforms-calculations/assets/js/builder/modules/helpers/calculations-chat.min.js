export default function(n){return{newCodeEditorContent:{},isPossibleToAnswer:!0,getAnswer(e){this.isPossibleToAnswer=!e.isImpossible,this.newCodeEditorContent[e.responseId]=e?.newCodeEditorContent??"";var t=e.answerText.title??"",s=e.answerText.details??"";let i=`
				<h4>${n.htmlSpecialChars(t)}</h4>
				<span>${n.htmlSpecialChars(s)}</span>
			`;return e.newCodeEditorContent&&this.isPossibleToAnswer&&(i+=`<pre dir="ltr">${n.htmlSpecialChars(this.newCodeEditorContent[e.responseId])}</pre>`),n.sessionId||(i+=this.isPossibleToAnswer?`<span>${n.modeStrings.footer}</span>`:`<span class="wpforms-ai-calculations-chat-answer-footer-learn-more">${n.modeStrings.footerLearnMore}</span>`),i},splitResponseText(e){let t,s;var i=e.indexOf(". ");return s=-1<i?(t=e.substring(0,i)+".",e.substring(i+1)):(t=e,""),[t,s]},getAnswerButtonsPre(){return this.isPossibleToAnswer?`
					<button type="button" class="wpforms-ai-chat-calculations-insert wpforms-ai-chat-answer-action wpforms-btn-sm wpforms-btn-orange" >
						<span>${n.modeStrings.insert}</span>
					</button>
				`:`
				<a class="wpforms-ai-chat-calculations-learn-more wpforms-ai-chat-answer-learn-more wpforms-btn-sm wpforms-btn-orange" href="${n.modeStrings.learnMoreUrl}" target="_blank" rel="noopener noreferrer">
					<span>${n.modeStrings.learnMoreButton}</span>
				</a>
			`},getWarningMessage(){return 0!==n.prefill.length?'<div class="wpforms-ai-chat-divider"></div>':this.getChatNotice(n.modeStrings.warning)},getInitialChat(e){return this.getChatNotice(e)},getChatNotice(e){return WPFormsAIModal.resizeModalHeight(n.fieldId),`<div class="wpforms-ai-chat-divider"></div>
					<div class="wpforms-chat-item-notice">
						<div class="wpforms-chat-item-notice-content">
							<span>${e}</span>
						</div>
					</div>`},isWelcomeScreen(){return 0===this.getCodeMirrorInstance(n.fieldId)?.getValue().trim().length},addedAnswer(e){e.querySelector(".wpforms-ai-chat-calculations-insert")?.addEventListener("click",this.insertButtonClick.bind(this))},sanitizeResponse(e){return e.answerText.details=n.htmlSpecialChars(e?.answerText?.details??""),e.answerText.title=n.htmlSpecialChars(e?.answerText?.title??""),e.isImpossible=Boolean(e?.isImpossible??!1),e.isImpossibleReason=n.htmlSpecialChars(e?.isImpossibleReason??""),e},insertButtonClick(e){let t=this.getCodeMirrorInstance(n.fieldId),s=jQuery(e.target).closest(".wpforms-chat-item.wpforms-chat-item-answer"),i=s.data("response-id"),r=this.newCodeEditorContent[i]??"";t&&(n.wpformsAiApi.rate(!0,i),jQuery(".jconfirm-wpforms-ai-modal-calculations-"+n.fieldId).addClass("wpforms-hidden").fadeOut(),Promise.all([jQuery("#wpforms-field-"+n.fieldId).click().promise(),jQuery(`#wpforms-field-option-advanced-${n.fieldId} a.wpforms-field-option-group-toggle`).click().promise()]).then(()=>{t.setValue(r+" "),t.setCursor(t.lineCount(),0)}))},prepareMessage(e){var t=this.getCodeMirrorInstance(n.fieldId)?.getValue()??"",s=JSON.stringify(this.reduceFormData(WPFormsBuilder.serializeAllData(jQuery("#wpforms-builder-form")))),e={fieldId:n.fieldId,promptText:e,currentCodeEditor:t,formJson:s};return JSON.stringify(e)},getCodeMirrorInstance(e){return WPFormsCalculationsBuilder?.getEditorInstance(`wpforms-field-option-${e}-calculation_code`)?.codemirror??null},reduceFormData(e){for(var t in e=this.removeRedundantFields(e))(e[t].name.startsWith("settings[")&&!e[t].name.startsWith("settings[form_desc]")&&!e[t].name.startsWith("settings[form_title]")||e[t].name.startsWith(`fields[${n.fieldId}][size]`)||e[t].name.startsWith(`fields[${n.fieldId}][map_position]`)||e[t].name.startsWith(`fields[${n.fieldId}][enable_address_autocomplete]`)||e[t].name.startsWith(`fields[${n.fieldId}][display_map]`)||e[t].name.startsWith(`fields[${n.fieldId}][css]`)||0===e[t].value.length||(e[t].name.endsWith("[calculation_code]")||e[t].name.endsWith("[calculation_is_enabled]"))&&!e[t].name.startsWith(`fields[${n.fieldId}][calculation_`))&&delete e[t];return e},removeRedundantFields(s){var e,t=["pagebreak","divider","file-upload","richtext","layout","signature","password"],i=[];for(e in s){var r=t.includes(s[e].value),n=s[e].name.startsWith("fields["),a=s[e].name.endsWith("][type]");r&&n&&a&&(r=s[e].name.split("[")[1].split("]")[0],i.includes(`fields[${r}]`)||i.push(`fields[${r}]`))}if(i.length)for(let t in s)i.find(e=>s[t].name.startsWith(e))&&delete s[t];return s}}}